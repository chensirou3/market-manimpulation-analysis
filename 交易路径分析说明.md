# 交易路径分析模块 (Trade Path Analysis)

## 📋 问题背景

### 您发现的关键问题

在之前的回测中，我们使用了**固定的5根K线时间止损**：

```python
holding_horizon = 5  # 持仓5根K线后强制平仓
```

**这个设计有严重问题**：

1. **掩盖了因子的真实质量**
   - 如果因子在第3根K线就达到最大盈利，我们却持有到第5根
   - 如果因子需要10根K线才能充分发挥，我们却在第5根就平仓
   - 我们无法知道**最优的持仓时间**是多少

2. **无法评估潜在收益**
   - 我们只知道"实现收益"（第5根K线的收益）
   - 不知道"潜在收益"（整个持仓期间的最大收益）
   - 无法计算**收益捕获效率**

3. **混淆了因子质量和出场策略**
   - 高Sharpe可能来自好的因子，也可能来自好的出场时机
   - 我们需要**分离这两个因素**

---

## 🎯 解决方案：交易路径分析

### 核心理念

**不使用任何固定的时间止损，而是追踪每笔交易的完整价格路径**，直到：

1. **亏损达到阈值**（如 -5 ATR）
2. **新信号出现**（关闭旧交易）
3. ~~**达到最大追踪时间**~~ **已移除** - 现在可以无限追踪

这样我们可以：
- ✅ 看到每笔交易的**完整生命周期**
- ✅ 知道**最大盈利何时出现**
- ✅ 评估**因子的原始质量**（不受出场策略影响）

---

## 📊 关键指标

### 1. MFE (Maximum Favorable Excursion)
**最大有利偏移** - 交易期间达到的最大盈利

```
示例：
入场价格：$40,000
第1根K线：$40,200 → MFE = +0.5%
第2根K线：$40,800 → MFE = +2.0% ← 最大盈利
第3根K线：$40,500 → MFE仍是 +2.0%
第4根K线：$40,300 → MFE仍是 +2.0%
第5根K线：$40,100 → MFE仍是 +2.0%

最终平仓：$40,100 → 实现收益 = +0.25%
```

**关键洞察**：
- MFE = +2.0%（潜在收益）
- 实现收益 = +0.25%
- **收益捕获率 = 0.25% / 2.0% = 12.5%**
- 我们损失了87.5%的潜在利润！

### 2. MAE (Maximum Adverse Excursion)
**最大不利偏移** - 交易期间达到的最大亏损

```
示例：
入场价格：$40,000
第1根K线：$39,800 → MAE = -0.5%
第2根K线：$39,500 → MAE = -1.25% ← 最大亏损
第3根K线：$39,800 → MAE仍是 -1.25%
第4根K线：$40,200 → MAE仍是 -1.25%
第5根K线：$40,500 → MAE仍是 -1.25%

最终平仓：$40,500 → 实现收益 = +1.25%
```

**关键洞察**：
- 即使最终盈利，也经历了-1.25%的回撤
- 可以用来设置**合理的止损位**

### 3. t_mfe (Timing of MFE)
**最大盈利出现的时间** - 第几根K线达到MFE

```
示例：
t_mfe = 2 → 第2根K线达到最大盈利
```

**关键洞察**：
- 如果 t_mfe 中位数 = 3，说明最优持仓时间是3根K线
- 如果我们用5根K线时间止损，就持有过久了
- 如果 t_mfe 中位数 = 10，说明应该持有更久

---

## 🔧 使用方法

### 基本用法

```python
from src.analysis.trade_path_analysis import (
    TradePathConfig,
    analyze_trade_paths_long_only,
    summarize_trade_paths,
    print_trade_path_summary
)

# 配置
config = TradePathConfig(
    max_loss_atr=5.0,        # 最大亏损5倍ATR
    max_holding_bars=None,   # 无时间限制（可以一直持有）
    price_col_for_pnl="close",  # 用收盘价计算盈亏
    entry_price_col="open"   # 用开盘价入场
)

# 运行分析
trades_df = analyze_trade_paths_long_only(
    bars=bars,           # K线数据
    signal_exec=signals, # 信号序列 (0或1)
    atr=atr,            # ATR序列
    config=config
)

# 查看结果
summary = summarize_trade_paths(trades_df)
print_trade_path_summary(summary)
```

### 输出示例

```
Trade Path Analysis Summary
================================================================================

📊 Basic Statistics
  Total trades: 358
  Winners: 156 (43.6%)
  Losers: 202

💰 PnL Statistics
  Average PnL: 0.12%
  Median PnL: 0.08%
  Avg Winner: 1.85%
  Avg Loser: -1.23%

📈 Maximum Favorable Excursion (MFE)
  Mean MFE: 2.45%          ← 平均潜在收益
  Median MFE: 1.89%
  Mean MFE (ATR): 1.87     ← 平均潜在收益（ATR单位）
  MFE for winners: 3.12%   ← 盈利交易的平均MFE
  MFE for losers: 1.56%    ← 亏损交易也有平均1.56%的潜在盈利！

📉 Maximum Adverse Excursion (MAE)
  Mean MAE: -1.34%
  Median MAE: -1.12%
  Mean MAE (ATR): -1.02

⏱️  Timing of Maximum Profit
  Mean t_mfe: 8.5 bars     ← 平均在第8.5根K线达到最大盈利
  Median t_mfe: 7.0 bars   ← 中位数是第7根K线
  25th percentile: 3.0 bars
  75th percentile: 12.0 bars

⏳ Holding Period
  Mean: 15.3 bars
  Median: 18.0 bars

🎯 Profit Capture Efficiency
  Realized / Potential: 4.9%   ← 只捕获了4.9%的潜在利润！
  (How much of the max profit we actually captured)

🚪 Exit Reasons
  NEW_SIGNAL: 97.8%        ← 97.8%因新信号退出
  ATR_STOP: 2.2%           ← 2.2%触发ATR止损
  END_OF_DATA: <1%         ← 数据结束时仍持仓
```

---

## 💡 关键洞察

### 测试数据的发现

从测试结果我们看到：

1. **收益捕获效率极低**
   - 平均潜在收益：1.94%
   - 平均实现收益：0.16%
   - **捕获率：8.2%** ← 损失了91.8%的潜在利润！

2. **最优持仓时间**
   - t_mfe 中位数：8根K线
   - 当前时间止损：5根K线
   - **建议：延长到8-10根K线**

3. **亏损交易也有盈利机会**
   - 亏损交易的平均MFE：1.57%
   - 说明即使最终亏损，期间也有盈利机会
   - **可以考虑动态止盈**

---

## 🎯 实际应用

### 1. 优化持仓时间

```python
# 分析t_mfe分布
t_mfe_median = summary['t_mfe_median']

if t_mfe_median < 5:
    print(f"建议缩短持仓时间到 {int(t_mfe_median)} 根K线")
elif t_mfe_median > 5:
    print(f"建议延长持仓时间到 {int(t_mfe_median)} 根K线")
```

### 2. 设置合理止损

```python
# 分析MAE分布
mae_atr_75 = trades_df['mae_atr'].quantile(0.75)
print(f"建议止损：{abs(mae_atr_75):.1f} ATR")
```

### 3. 评估因子质量

```python
# 比较盈利和亏损交易的MFE
mfe_winners = winners['mfe'].mean()
mfe_losers = losers['mfe'].mean()

if mfe_losers > 0.01:  # 亏损交易也有>1%的MFE
    print("因子质量好，但出场策略需要优化")
else:
    print("因子质量可能有问题")
```

---

## 📁 文件说明

### 核心模块
- `src/analysis/trade_path_analysis.py` - 主模块

### 示例脚本
- `test_trade_path_analysis.py` - 简单测试（合成数据）
- `example_trade_path_analysis.py` - 完整示例（BTC数据）

### 输出文件
- `results/btc_4h_trade_path_analysis.csv` - 交易路径分析结果

---

## 🚀 下一步

1. **运行BTC 4H分析**
   ```bash
   python example_trade_path_analysis.py
   ```

2. **对比不同时间周期**
   - 5min, 15min, 30min, 60min, 4H
   - 看哪个周期的t_mfe最稳定

3. **优化出场策略**
   - 基于t_mfe设置动态持仓时间
   - 基于MFE设置移动止盈
   - 基于MAE设置合理止损

4. **扩展到多空策略**
   - 修改模块支持 signal ∈ {-1, 0, +1}
   - 分别分析多头和空头的MFE/MAE

---

## ⚠️ 重要说明

### 这个模块的特点

✅ **无资金约束**
- 每笔交易独立分析
- 不考虑账户权益
- 不跳过任何信号

✅ **无固定出场**
- 不使用固定时间止损
- 追踪完整价格路径
- 直到触发退出条件

✅ **纯因子分析**
- 评估信号的原始质量
- 不受出场策略影响
- 可以指导出场策略优化

❌ **不是回测引擎**
- 不计算总权益曲线
- 不考虑复利
- 不模拟真实交易

---

**总结**：这个模块帮助我们**看清因子的真实质量**，而不被固定的时间止损所掩盖。

