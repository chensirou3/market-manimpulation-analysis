# äº¤æ˜“è·¯å¾„åˆ†æ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**æ‚¨çš„å‘ç°**ï¼šå›ºå®šçš„5æ ¹Kçº¿æ—¶é—´æ­¢æŸä¼šæ©ç›–å› å­çš„çœŸå®è´¨é‡

**åŸå› **ï¼š
- æˆ‘ä»¬ä¸çŸ¥é“æœ€ä¼˜æŒä»“æ—¶é—´æ˜¯å¤šå°‘
- æˆ‘ä»¬ä¸çŸ¥é“æ½œåœ¨æ”¶ç›Šæœ‰å¤šå¤§
- æˆ‘ä»¬æ— æ³•åˆ†ç¦»"å› å­è´¨é‡"å’Œ"å‡ºåœºç­–ç•¥"

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

**äº¤æ˜“è·¯å¾„åˆ†æ**ï¼šè¿½è¸ªæ¯ç¬”äº¤æ˜“çš„å®Œæ•´ä»·æ ¼è·¯å¾„ï¼ˆæ— æ—¶é—´é™åˆ¶ï¼‰ï¼Œè®°å½•ï¼š
- **MFE** (Maximum Favorable Excursion) - æœ€å¤§ç›ˆåˆ©
- **MAE** (Maximum Adverse Excursion) - æœ€å¤§äºæŸ
- **t_mfe** - æœ€å¤§ç›ˆåˆ©å‡ºç°çš„æ—¶é—´

**é€€å‡ºæ¡ä»¶**ï¼š
1. äºæŸè¾¾åˆ° -5 ATRï¼ˆä¿æŠ¤æ€§æ­¢æŸï¼‰
2. æ–°ä¿¡å·å‡ºç°ï¼ˆå…³é—­æ—§äº¤æ˜“ï¼‰
3. æ•°æ®ç»“æŸï¼ˆå¼ºåˆ¶å¹³ä»“ï¼‰

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥ï¼‰

### 1. è¿è¡Œæµ‹è¯•ï¼ˆéªŒè¯æ¨¡å—ï¼‰

```bash
python test_trade_path_analysis.py
```

**é¢„æœŸè¾“å‡º**ï¼š
```
ğŸ“Š Basic Statistics
  Total trades: 32
  Winners: 17 (53.1%)

ğŸ’° PnL Statistics
  Average PnL: 0.16%

ğŸ“ˆ Maximum Favorable Excursion (MFE)
  Mean MFE: 1.94%          â† å¹³å‡æ½œåœ¨æ”¶ç›Š
  
ğŸ¯ Profit Capture Efficiency
  Realized / Potential: 8.2%   â† åªæ•è·äº†8.2%ï¼
```

### 2. è¿è¡ŒBTCåˆ†æï¼ˆçœŸå®æ•°æ®ï¼‰

```bash
python example_trade_path_analysis.py
```

**è¿™ä¼šåˆ†æ**ï¼š
- BTC 4Hæ•°æ®
- çº¯å› å­ç­–ç•¥ï¼ˆLong-Onlyï¼‰
- è¿½è¸ªæ¯ç¬”äº¤æ˜“æœ€å¤š50æ ¹Kçº¿

### 3. æŸ¥çœ‹ç»“æœ

```python
import pandas as pd

# è¯»å–ç»“æœ
trades = pd.read_csv('results/btc_4h_trade_path_analysis.csv')

# å…³é”®æŒ‡æ ‡
print(f"å¹³å‡MFE: {trades['mfe'].mean()*100:.2f}%")
print(f"å¹³å‡å®ç°æ”¶ç›Š: {trades['pnl_final'].mean()*100:.2f}%")
print(f"æœ€ä¼˜æŒä»“æ—¶é—´: {trades['t_mfe'].median():.0f} æ ¹Kçº¿")
```

---

## ğŸ“Š å…³é”®æŒ‡æ ‡è§£è¯»

### MFE (æœ€å¤§æœ‰åˆ©åç§»)

```
å…¥åœºï¼š$40,000
ç¬¬1æ ¹ï¼š$40,200 (+0.5%)
ç¬¬2æ ¹ï¼š$40,800 (+2.0%) â† MFE
ç¬¬3æ ¹ï¼š$40,500 (+1.25%)
ç¬¬5æ ¹ï¼š$40,100 (+0.25%) â† å®ç°æ”¶ç›Š

MFE = 2.0%ï¼ˆæ½œåœ¨æ”¶ç›Šï¼‰
å®ç° = 0.25%
æ•è·ç‡ = 12.5%
```

**æ´å¯Ÿ**ï¼šæˆ‘ä»¬æŸå¤±äº†87.5%çš„æ½œåœ¨åˆ©æ¶¦ï¼

### t_mfe (æœ€ä¼˜æ—¶æœº)

```
t_mfe = 2 â†’ ç¬¬2æ ¹Kçº¿è¾¾åˆ°æœ€å¤§ç›ˆåˆ©
```

**æ´å¯Ÿ**ï¼š
- å¦‚æœ t_mfe ä¸­ä½æ•° < 5ï¼šåº”è¯¥ç¼©çŸ­æŒä»“æ—¶é—´
- å¦‚æœ t_mfe ä¸­ä½æ•° > 5ï¼šåº”è¯¥å»¶é•¿æŒä»“æ—¶é—´

### MAE (æœ€å¤§ä¸åˆ©åç§»)

```
å…¥åœºï¼š$40,000
ç¬¬1æ ¹ï¼š$39,800 (-0.5%)
ç¬¬2æ ¹ï¼š$39,500 (-1.25%) â† MAE
ç¬¬3æ ¹ï¼š$40,200 (+0.5%)
ç¬¬5æ ¹ï¼š$40,500 (+1.25%) â† å®ç°æ”¶ç›Š

MAE = -1.25%
```

**æ´å¯Ÿ**ï¼šå¯ä»¥ç”¨æ¥è®¾ç½®åˆç†çš„æ­¢æŸä½

---

## ğŸ’» ä»£ç ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•

```python
from src.analysis.trade_path_analysis import (
    TradePathConfig,
    analyze_trade_paths_long_only,
    summarize_trade_paths,
    print_trade_path_summary
)

# 1. é…ç½®
config = TradePathConfig(
    max_loss_atr=5.0,        # æœ€å¤§äºæŸ5å€ATRï¼ˆä¿æŠ¤æ€§æ­¢æŸï¼‰
    max_holding_bars=None,   # æ— æ—¶é—´é™åˆ¶ï¼ˆè®©äº¤æ˜“è‡ªç„¶å‘å±•ï¼‰
    price_col_for_pnl="close",
    entry_price_col="open"
)

# 2. è¿è¡Œåˆ†æ
trades_df = analyze_trade_paths_long_only(
    bars=bars,           # Kçº¿æ•°æ®ï¼ˆDataFrameï¼‰
    signal_exec=signals, # ä¿¡å·ï¼ˆSeriesï¼Œ0æˆ–1ï¼‰
    atr=atr,            # ATRï¼ˆSeriesï¼‰
    config=config
)

# 3. æŸ¥çœ‹ç»“æœ
summary = summarize_trade_paths(trades_df)
print_trade_path_summary(summary)
```

### ä¼˜åŒ–æŒä»“æ—¶é—´

```python
# åˆ†ææœ€ä¼˜æŒä»“æ—¶é—´
t_mfe_median = summary['t_mfe_median']
current_holding = 5

if t_mfe_median < current_holding:
    print(f"å»ºè®®ç¼©çŸ­åˆ° {int(t_mfe_median)} æ ¹Kçº¿")
elif t_mfe_median > current_holding:
    print(f"å»ºè®®å»¶é•¿åˆ° {int(t_mfe_median)} æ ¹Kçº¿")
else:
    print("å½“å‰æŒä»“æ—¶é—´æ¥è¿‘æœ€ä¼˜")
```

### è¯„ä¼°å› å­è´¨é‡

```python
# åˆ†ç¦»ç›ˆåˆ©å’ŒäºæŸäº¤æ˜“
winners = trades_df[trades_df['pnl_final'] > 0]
losers = trades_df[trades_df['pnl_final'] <= 0]

# äºæŸäº¤æ˜“çš„MFE
mfe_losers = losers['mfe'].mean()

if mfe_losers > 0.01:  # >1%
    print("âœ… å› å­è´¨é‡å¥½ï¼Œä½†å‡ºåœºç­–ç•¥éœ€è¦ä¼˜åŒ–")
    print(f"   äºæŸäº¤æ˜“å¹³å‡ä¹Ÿæœ‰ {mfe_losers*100:.2f}% çš„ç›ˆåˆ©æœºä¼š")
else:
    print("âš ï¸  å› å­è´¨é‡å¯èƒ½æœ‰é—®é¢˜")
```

---

## ğŸ“ˆ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯1ï¼šä¼˜åŒ–BTCç­–ç•¥

```bash
# è¿è¡Œåˆ†æ
python example_trade_path_analysis.py

# æŸ¥çœ‹ç»“æœ
# å‡è®¾å‘ç°ï¼št_mfeä¸­ä½æ•° = 8æ ¹Kçº¿
# å½“å‰ç­–ç•¥ï¼š5æ ¹Kçº¿æ—¶é—´æ­¢æŸ

# ç»“è®ºï¼šåº”è¯¥å»¶é•¿åˆ°8æ ¹Kçº¿
```

### åœºæ™¯2ï¼šå¯¹æ¯”ä¸åŒæ—¶é—´å‘¨æœŸ

```python
# åˆ†æ5min, 15min, 30min, 60min, 4H
for timeframe in ['5min', '15min', '30min', '60min', '4h']:
    bars = load_bars(timeframe)
    signals = generate_signals(bars)
    atr = compute_atr(bars)
    
    trades = analyze_trade_paths_long_only(bars, signals, atr, config)
    summary = summarize_trade_paths(trades)
    
    print(f"{timeframe}: t_mfe={summary['t_mfe_median']:.0f}, "
          f"MFE={summary['mfe_mean']*100:.2f}%")
```

### åœºæ™¯3ï¼šè®¾ç½®åŠ¨æ€æ­¢ç›ˆ

```python
# åŸºäºMFEåˆ†å¸ƒè®¾ç½®æ­¢ç›ˆ
mfe_atr_75 = trades_df['mfe_atr'].quantile(0.75)
print(f"å»ºè®®æ­¢ç›ˆï¼š{mfe_atr_75:.1f} ATR")

# åŸºäºMAEåˆ†å¸ƒè®¾ç½®æ­¢æŸ
mae_atr_75 = abs(trades_df['mae_atr'].quantile(0.25))
print(f"å»ºè®®æ­¢æŸï¼š{mae_atr_75:.1f} ATR")
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
market-manipulation-analysis/
â”œâ”€â”€ src/analysis/
â”‚   â””â”€â”€ trade_path_analysis.py          # æ ¸å¿ƒæ¨¡å—
â”œâ”€â”€ test_trade_path_analysis.py         # æµ‹è¯•è„šæœ¬ï¼ˆåˆæˆæ•°æ®ï¼‰
â”œâ”€â”€ example_trade_path_analysis.py      # ç¤ºä¾‹è„šæœ¬ï¼ˆBTCæ•°æ®ï¼‰
â”œâ”€â”€ äº¤æ˜“è·¯å¾„åˆ†æè¯´æ˜.md                  # è¯¦ç»†æ–‡æ¡£
â””â”€â”€ äº¤æ˜“è·¯å¾„åˆ†æ_å¿«é€Ÿå¼€å§‹.md             # æœ¬æ–‡æ¡£
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ

1. âœ… è¿è¡Œæµ‹è¯•éªŒè¯æ¨¡å—
   ```bash
   python test_trade_path_analysis.py
   ```

2. âœ… åˆ†æBTC 4Hæ•°æ®
   ```bash
   python example_trade_path_analysis.py
   ```

3. âœ… æŸ¥çœ‹å…³é”®æŒ‡æ ‡
   - t_mfeä¸­ä½æ•°æ˜¯å¤šå°‘ï¼Ÿ
   - æ”¶ç›Šæ•è·ç‡æ˜¯å¤šå°‘ï¼Ÿ
   - äºæŸäº¤æ˜“çš„MFEæ˜¯å¤šå°‘ï¼Ÿ

### åç»­ä¼˜åŒ–

4. ğŸ“‹ å¯¹æ¯”ä¸åŒæ—¶é—´å‘¨æœŸ
   - ä¿®æ”¹ `example_trade_path_analysis.py`
   - æµ‹è¯• 5min, 15min, 30min, 60min

5. ğŸ“‹ ä¼˜åŒ–æŒä»“æ—¶é—´
   - åŸºäºt_mfeè°ƒæ•´ `holding_horizon`
   - é‡æ–°å›æµ‹éªŒè¯

6. ğŸ“‹ è®¾ç½®åŠ¨æ€æ­¢ç›ˆæ­¢æŸ
   - åŸºäºMFE/MAEåˆ†å¸ƒ
   - æ›¿ä»£å›ºå®šçš„0.5/0.8 ATR

---

## âš ï¸ é‡è¦æé†’

### è¿™ä¸ªæ¨¡å—çš„ä½œç”¨

âœ… **åˆ†æå› å­è´¨é‡**
- çœ‹æ¸…å› å­çš„çœŸå®æ½œåŠ›
- ä¸å—å›ºå®šå‡ºåœºç­–ç•¥å½±å“

âœ… **æŒ‡å¯¼ç­–ç•¥ä¼˜åŒ–**
- æ‰¾åˆ°æœ€ä¼˜æŒä»“æ—¶é—´
- è®¾ç½®åˆç†æ­¢ç›ˆæ­¢æŸ

âŒ **ä¸æ˜¯å›æµ‹å¼•æ“**
- ä¸è®¡ç®—æ€»æƒç›Š
- ä¸è€ƒè™‘å¤åˆ©
- ä»…ç”¨äºåˆ†æ

---

## ğŸ“ å¿«é€Ÿå‚è€ƒ

### å…³é”®å‡½æ•°

```python
# è¿è¡Œåˆ†æ
trades_df = analyze_trade_paths_long_only(bars, signals, atr, config)

# è®¡ç®—ç»Ÿè®¡
summary = summarize_trade_paths(trades_df)

# æ‰“å°æŠ¥å‘Š
print_trade_path_summary(summary)
```

### å…³é”®æŒ‡æ ‡

- `mfe` - æœ€å¤§ç›ˆåˆ©ï¼ˆ%ï¼‰
- `mae` - æœ€å¤§äºæŸï¼ˆ%ï¼‰
- `t_mfe` - æœ€å¤§ç›ˆåˆ©å‡ºç°æ—¶é—´ï¼ˆæ ¹Kçº¿ï¼‰
- `pnl_final` - å®ç°æ”¶ç›Šï¼ˆ%ï¼‰
- `profit_capture_ratio` - æ”¶ç›Šæ•è·ç‡

---

**å¼€å§‹åˆ†æï¼** ğŸš€

è¿è¡Œ `python test_trade_path_analysis.py` éªŒè¯æ¨¡å—æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

