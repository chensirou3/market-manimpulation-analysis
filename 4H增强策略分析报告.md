# 4小时增强策略分析报告

## 📋 研究目标

在已有的4小时非对称策略（Sharpe 4.03）基础上，测试两种高级过滤器：
1. **日线融合过滤**：要求4小时信号与日线regime一致
2. **聚类过滤**：区分孤立事件vs持续操纵模式

**假设**：这些过滤器能提高每笔交易的edge，即使减少信号数量。

---

## 🔬 实验设计

### 测试的策略变体

| 变体 | 日线过滤 | 聚类过滤 | 描述 |
|------|---------|---------|------|
| A | ❌ | ❌ | Baseline（无过滤） |
| B | ✅ | ❌ | 仅日线融合 |
| C | ❌ | ✅ | 仅聚类过滤 |
| D | ✅ | ✅ | 两者结合 |

### 数据
- **时间范围**：2015-2025（11年）
- **4小时K线**：17,187根
- **日线K线**：3,341根
- **策略类型**：非对称（UP=continuation, DOWN=reversal）

---

## 📊 核心结果

### 主要实验结果

| 变体 | 信号数 | 保留率 | Sharpe | 总收益 | 胜率 | 最大回撤 |
|------|--------|--------|--------|--------|------|----------|
| **A: Baseline** | **358** | **100%** | **4.03** 🥇 | **13.09%** 🥇 | 43.6% | -7.40% |
| B: Daily | 7 | 2.0% | - | - | - | - |
| C: Clustering | 67 | 18.7% | 1.58 | 3.59% | 44.8% | -4.40% |
| D: Daily+Clustering | 2 | 0.6% | - | - | - | - |

**关键发现**：
- ✅ **Baseline策略已经是最优**（Sharpe 4.03）
- ❌ **日线过滤过于严格**（只保留2%信号，无法回测）
- ❌ **聚类过滤降低了性能**（Sharpe从4.03降到1.58）

---

## 🔍 参数敏感性分析

### 聚类参数测试

测试了9种参数组合：`(window_W, min_count, q_high_manip)`

| W | min_count | q_manip | 信号数 | 保留率 | Sharpe | 总收益 | 胜率 |
|---|-----------|---------|--------|--------|--------|--------|------|
| 4 | 2 | 0.90 | 163 | 45.5% | **3.81** 🥈 | 10.35% | 44.8% |
| **8** | **4** | **0.90** | **37** | **10.3%** | **3.96** 🥇 | **7.00%** | **54.1%** 🥇 |
| 4 | 2 | 0.85 | 203 | 56.7% | 3.69 | 10.54% | 43.8% |
| 6 | 2 | 0.85 | 248 | 69.3% | 2.29 | 7.35% | 41.9% |
| 8 | 3 | 0.90 | 90 | 25.1% | 2.36 | 5.80% | 45.6% |
| 6 | 2 | 0.90 | 202 | 56.4% | 2.19 | 6.71% | 42.1% |
| 6 | 3 | 0.90 | 67 | 18.7% | 1.58 | 3.59% | 44.8% |
| 8 | 3 | 0.85 | 141 | 39.4% | 1.37 | 3.95% | 40.4% |
| 6 | 3 | 0.85 | 93 | 26.0% | -0.32 | -0.85% | 37.6% |

**最佳聚类参数**：
- **W=8, min_count=4, q_manip=0.90**
- Sharpe 3.96（接近baseline的4.03）
- 胜率54.1%（比baseline高10.5个百分点！）
- 但信号数只有37个（10.3%保留率）

### 日线融合参数测试

测试了6种参数组合：`(q_extreme_trend, q_high_manip)`

| q_trend | q_manip | 信号数 | 保留率 | Sharpe | 总收益 | 胜率 |
|---------|---------|--------|--------|--------|--------|------|
| 0.80 | 0.85 | 12 | 3.4% | 1.61 | 1.96% | 41.7% |
| 0.80 | 0.80 | 13 | 3.6% | 1.45 | 1.77% | 38.5% |
| 0.85 | 0.85 | 10 | 2.8% | -0.03 | -0.03% | 30.0% |
| 其他 | - | <10 | <2.8% | - | - | - |

**日线融合结论**：
- 即使最宽松的参数（0.80, 0.80），也只保留3.6%的信号
- 性能远不如baseline（Sharpe 1.45 vs 4.03）
- **日线融合过滤不适用于此策略**

---

## 💡 关键洞察

### 1️⃣ **Baseline策略已经非常优秀**

4小时非对称策略（无额外过滤）：
- Sharpe 4.03（极高的风险调整收益）
- 11年总收益13.09%
- 358笔交易（~33笔/年）
- 最大回撤-7.40%（可控）

**这个策略已经捕捉到了核心的操纵模式，无需额外过滤。**

### 2️⃣ **聚类过滤的悖论**

**假设**：聚类事件（持续多个K线的高ManipScore）应该比孤立事件质量更高。

**实际结果**：
- 标准聚类过滤（W=6, min_count=3）：Sharpe **下降**到1.58
- 最优聚类过滤（W=8, min_count=4）：Sharpe 3.96，**接近**baseline

**可能原因**：
- 孤立的极端ManipScore事件可能反而是最强的反转信号
- 聚类事件可能代表"正常"的趋势延续，而非操纵
- 过度过滤去除了有价值的信号

### 3️⃣ **日线融合过滤过于严格**

**问题**：
- 4小时极端事件与日线极端事件的重叠度很低（<5%）
- 这两个时间尺度捕捉的是**不同类型**的市场行为
- 强制要求两者一致会过度限制信号

**结论**：
- 4小时和日线应该作为**独立策略**，而非融合
- 或者使用更宽松的日线条件（如日线方向一致，而非极端）

### 4️⃣ **质量vs数量的权衡**

| 策略 | 信号数 | Sharpe | 胜率 | 每笔平均收益 |
|------|--------|--------|------|--------------|
| Baseline | 358 | 4.03 | 43.6% | 3.66 bps |
| 最优聚类 | 37 | 3.96 | 54.1% | 18.92 bps |

**发现**：
- 最优聚类过滤提高了胜率（+10.5%）和每笔收益（+5.2倍）
- 但信号数减少90%，导致总收益下降（13.09% → 7.00%）
- **Sharpe几乎相同**（4.03 vs 3.96）

---

## 🎯 最终建议

### 推荐策略

**采用Baseline 4小时非对称策略（无额外过滤）**

**理由**：
1. ✅ 最高Sharpe（4.03）
2. ✅ 最高总收益（13.09%）
3. ✅ 足够的交易频率（~33笔/年）
4. ✅ 简单、稳定、可解释

### 可选优化方向

如果需要**更高胜率、更少交易**，可以考虑：
- **聚类过滤变体**：W=8, min_count=4, q_manip=0.90
- Sharpe 3.96（略低于baseline）
- 胜率54.1%（显著高于baseline）
- 信号数37（~3.4笔/年）

### 不推荐

❌ **日线融合过滤**：过于严格，性能不佳

---

## 📈 后续研究方向

1. **多时间周期组合**
   - 4小时 + 日线作为**独立策略**并行运行
   - 而非融合过滤

2. **动态参数**
   - 根据市场波动率调整止损止盈
   - 根据ManipScore分布调整阈值

3. **风险管理优化**
   - 测试不同的SL/TP参数
   - 测试仅时间退出（无SL/TP）

4. **因子组合**
   - 测试其他微观结构特征
   - 测试订单流不平衡指标

---

## 📁 生成的文件

- `results/4h_filter_comparison_stats.csv` - 主要实验结果
- `results/4h_clustering_sensitivity.csv` - 聚类参数敏感性
- `results/4h_daily_sensitivity.csv` - 日线参数敏感性

---

**结论**：4小时非对称策略已经是一个非常优秀的策略（Sharpe 4.03），额外的过滤器并未带来显著改进。保持简单往往是最好的选择。

