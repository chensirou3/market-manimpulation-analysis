# 市场操纵检测策略 - 快速参考卡

**版本**: 1.0 | **日期**: 2025-11-16

---

## 核心公式（一页纸）

### 1. 对数收益率
```
log_return[t] = ln(close[t] / close[t-1])
```

### 2. 波动率
```
sigma[t] = std(log_return[t-19:t])  # 20个bar窗口
```

### 3. 趋势强度
```
R_past[t] = sum(log_return[t-4:t])  # 5个bar
TS[t] = R_past[t] / sigma[t]
```

### 4. ManipScore
```
# 步骤1: 回归 (✅ 使用当前bar的绝对收益)
abs_ret[t] = α + β₁*R_past[t] + β₂*sigma[t] + ε[t]

# 步骤2: 标准化残差
ManipScore[t] = (ε[t] - mean(ε)) / std(ε)
```

### 5. 信号生成
```
threshold_TS = quantile(|TS|, 0.9)
threshold_MS = quantile(ManipScore, 0.9)

signal[t+1] = 1 if (|TS[t]| > threshold_TS) AND (ManipScore[t] > threshold_MS)
signal[t+1] = 0 otherwise
```

### 6. ATR
```
TR[t] = max(high[t]-low[t], |high[t]-close[t-1]|, |low[t]-close[t-1]|)
ATR[t] = mean(TR[t-9:t])  # 10个bar窗口
```

### 7. 止损止盈
```
sl_price = entry_price - 0.5 * ATR
tp_price = entry_price + 0.8 * ATR
```

### 8. 收益计算
```
pnl_pct = (exit_price - entry_price) / entry_price - 0.0007  # 扣除7bp成本
```

---

## 推荐配置

### BTC 60分钟纯因子（最优）

```python
{
    'bar_size': '60min',
    'L_past': 5,
    'vol_window': 20,
    'q_extreme_trend': 0.9,
    'L_future': 5,
    'q_manip': 0.9,
    'holding_horizon': 5,
    'atr_window': 10,
    'sl_atr_mult': 999.0,  # 不使用
    'tp_atr_mult': 999.0,  # 不使用
    'cost_per_trade': 0.0007
}
```

**预期**: 年化33.25%, Sharpe 16.50, 最大回撤-31.17%

---

### ETH 30分钟+止损止盈（平衡）

```python
{
    'bar_size': '30min',
    'L_past': 5,
    'vol_window': 20,
    'q_extreme_trend': 0.9,
    'L_future': 5,
    'q_manip': 0.9,
    'holding_horizon': 5,
    'atr_window': 10,
    'sl_atr_mult': 0.5,
    'tp_atr_mult': 0.8,
    'cost_per_trade': 0.0007
}
```

**预期**: 年化27.50%, Sharpe 5.20, 最大回撤-35.69%

---

### BTC 4小时纯因子（稳健）

```python
{
    'bar_size': '4h',
    'L_past': 5,
    'vol_window': 20,
    'q_extreme_trend': 0.9,
    'L_future': 5,
    'q_manip': 0.9,
    'holding_horizon': 5,
    'atr_window': 10,
    'sl_atr_mult': 999.0,
    'tp_atr_mult': 999.0,
    'cost_per_trade': 0.0007
}
```

**预期**: 年化14.87%, Sharpe 107.91, 最大回撤-35.24%

---

## 数据要求

### 最小数据量
```
最小bar数 = max(L_past, L_future, vol_window, atr_window) + 100
         = max(5, 5, 20, 10) + 100
         = 120个bar
```

### 数据格式
```csv
timestamp,open,high,low,close,volume
2024-01-01 00:00:00,42000.00,42100.00,41900.00,42050.00,1000
2024-01-01 01:00:00,42050.00,42150.00,42000.00,42100.00,1200
```

---

## 验证检查点

### 特征验证
```python
assert abs(bars['ManipScore'].mean()) < 0.1  # 均值接近0
assert abs(bars['ManipScore'].std() - 1.0) < 0.1  # 标准差接近1
assert 0.01 <= signals['signal'].mean() <= 0.05  # 信号频率1-5%
```

### 性能验证（BTC 60min, 7bp成本）
```python
tolerance = 0.10  # 10%容差
assert 7.0 <= result['total_return'] <= 9.0  # 总收益700-900%
assert 14.0 <= result['sharpe_ratio'] <= 19.0  # Sharpe 14-19
assert -0.35 <= result['max_drawdown'] <= -0.28  # 回撤-35%到-28%
assert 1000 <= result['num_trades'] <= 1200  # 交易1000-1200笔
```

---

## 常见问题速查

| 问题 | 原因 | 解决 |
|------|------|------|
| ManipScore全是NaN | 数据不足 | 确保至少120个bar |
| 信号频率>10% | 阈值太低 | 提高q_extreme_trend到0.95 |
| 收益远低于预期 | 成本设置错误 | 检查cost_per_trade=0.0007 |
| 止损价为负 | ATR为NaN | 填充ATR: `atr.ffill().bfill()` |
| 回测很慢 | 使用循环 | 改用向量化操作 |

---

## 关键注意事项

### ✅ 必须做
1. 信号延迟1个bar（避免前视偏差）
2. 扣除交易成本（7bp）
3. ManipScore标准化（均值0，标准差1）
4. 使用对数收益率（不是简单收益率）

### ❌ 不要做
1. 不要在5分钟或15分钟周期交易（成本太高）
2. 不要在60分钟使用止损止盈（降低收益）
3. 不要在XAUUSD使用此策略（不盈利）
4. 不要忘记前向填充波动率缺失值

---

## 快速实现（10行代码）

```python
import pandas as pd
import numpy as np
from sklearn.linear_model import LinearRegression

# 1. 加载数据
bars = pd.read_csv('bars_60min.csv', parse_dates=['timestamp'], index_col='timestamp')

# 2. 计算特征
bars['r'] = np.log(bars['close'] / bars['close'].shift(1))
bars['sigma'] = bars['r'].rolling(20).std().ffill()
bars['R_past'] = bars['r'].rolling(5).sum()
bars['TS'] = bars['R_past'] / bars['sigma']

# 3. 拟合ManipScore (✅ 使用当前bar的绝对收益)
bars['abs_ret'] = bars['r'].abs()
valid = bars[['R_past', 'sigma', 'abs_ret']].notna().all(1)
X, y = bars.loc[valid, ['R_past', 'sigma']], bars.loc[valid, 'abs_ret']
model = LinearRegression().fit(X, y)
resid = y - model.predict(X)
bars.loc[valid, 'MS'] = (resid - resid.mean()) / resid.std()

# 4. 生成信号
th_ts, th_ms = bars['TS'].abs().quantile(0.9), bars['MS'].quantile(0.9)
bars['signal'] = ((bars['TS'].abs() > th_ts) & (bars['MS'] > th_ms)).astype(int).shift(1)

# 5. 简单回测
bars['ret'] = bars['signal'] * bars['r'].shift(-1) - 0.0007 * bars['signal']
print(f"Total Return: {bars['ret'].sum()*100:.2f}%")
```

---

## 性能基准（7bp成本）

| 策略 | 年化收益 | Sharpe | 回撤 | 交易/年 | 持仓时间 |
|------|---------|--------|------|---------|---------|
| ETH 60min Pure | 35.01% | 14.18 | -53.76% | 145 | 5h |
| BTC 60min Pure | 33.25% | 16.50 | -31.17% | 146 | 5h |
| ETH 30min+SL/TP | 27.50% | 5.20 | -35.69% | 372 | 0.7h |
| BTC 4h Pure | 14.87% | 107.91 | -35.24% | 32 | 20h |

---

## 文件清单

| 文件 | 说明 |
|------|------|
| `策略技术文档_完整复现指南.md` | 完整技术文档（1800行） |
| `策略快速参考卡.md` | 本文档（快速参考） |
| `策略详细分析_7bp成本.md` | 7bp成本下的详细分析 |
| `results/detailed_strategy_analysis_7bp.csv` | 详细回测数据 |
| `src/strategies/extreme_reversal.py` | 策略配置 |
| `src/strategies/backtest_reversal.py` | 回测引擎 |
| `src/strategies/trend_features.py` | 特征计算 |

---

**快速开始**: 阅读完整技术文档 → 准备数据 → 运行示例代码 → 验证结果 → 开始实盘

**完整文档**: `策略技术文档_完整复现指南.md`

